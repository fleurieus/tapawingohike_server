{% extends "_base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}TapawingoHikeEditor · Live map · {{ route.name }}{% endblock %}

{% block head %}
<style>
  .panel-enter { opacity: 0; transform: translateX(16px); transition: all .18s ease; }
  .panel-enter.show { opacity: 1; transform: translateX(0); }
  .icon-btn{
    background: transparent; border: 0; padding: 2px; line-height: 1;
    color: #64748b; border-radius: 8px; cursor: pointer;
  }
  .icon-btn:hover{ color: #0f172a; }
  .icon-btn:focus{ outline: 2px solid rgba(148,163,184,.6); outline-offset: 2px; }
  /* AdvancedMarker content helpers */
  .pin-wrap { position: relative; width: 48px; height: 64px; display: inline-block; }
  .pin-wrap > img { width: 48px; height: 64px; display:block; }
  .badge {
    position: absolute; right: -6px; top: -6px; min-width: 18px; height: 18px;
    padding: 0 4px; background: #111827; color: white; font-size: 11px; line-height: 18px;
    border-radius: 9999px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,.25);
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 h-[calc(100vh-107px)] flex flex-col">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-semibold">Live map · {{ route.name }}</h1>
      <div class="text-sm text-slate-600">Edition: {{ route.edition.name }}</div>
    </div>
    <div class="flex items-center gap-2">
      <a class="text-sm hover:underline" href="{% url 'backoffice:routes_page' %}?edition={{ route.edition.id }}">← Terug</a>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-4 flex-1 min-h-0">
    <!-- Kaart -->
    <div class="col-span-2">
      <div id="map"
           class="w-full h-full bg-white rounded shadow-sm"
           data-map-id="{{ GOOGLE_MAPS_MAP_ID }}"
           data-route-id="{{ route.id }}"></div>
    </div>

    <!-- Rechterkolom: filters + sidepanel component hergebruiken -->
    <div class="col-span-1 h-full min-h-0 grid grid-rows-[minmax(0,1fr)_minmax(0,1fr)] gap-3">
      <!-- Filters -->
      <div class="bg-white rounded shadow-sm p-3 overflow-auto min-h-0">
        <div class="mb-2 flex items-center justify-between">
          <div class="font-medium">Filter</div>
        </div>

        <!-- Team filter -->
        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <input id="all-teams" type="checkbox" class="h-4 w-4 border-slate-300 rounded" checked>
            <label for="all-teams" class="text-sm">All teams</label>
          </div>
          <ul class="space-y-1" id="team-filter-list">
            {% for team in teams %}
              <li class="flex items-center gap-2">
                <input type="checkbox"
                      class="team-filter h-4 w-4 border-slate-300 rounded"
                      id="team-{{ team.id }}"
                      data-team="{{ team.id }}"
                      checked>
                <span class="inline-block w-3 h-3 rounded"
                      data-legend-color
                      data-team-id="{{ team.id }}"></span>
                <label for="team-{{ team.id }}" class="text-sm">{{ team.name }}</label>
              </li>
            {% endfor %}
          </ul>


        </div>

        <!-- Show on map -->
        <div class="mb-2">
          <div class="flex items-center gap-2">
            <input id="destinations-filter" type="checkbox" class="h-4 w-4 border-slate-300 rounded" checked>
            <span class="inline-block w-3 h-3 rounded" data-legend-color id="destinations-color"></span>            
            <label for="destinations-filter" class="text-sm">Destinations</label>
          </div>
        </div>
      </div>

      <!-- Zijpaneel placeholder voor consistentie - zelfde componentstyle -->
      <div id="sidepanel" class="bg-white rounded shadow-sm p-0 overflow-auto min-h-0"></div>
    </div>
  </div>

  <!-- HTMX poll: elke 5s state ophalen -->
  <div id="route-map-poller"
       hx-get="{% url 'backoffice:route_map_state' route.id %}"
       hx-trigger="load, every 5s"
       hx-swap="none">
  </div>
</div>

<!-- Initial payloads -->
{{ teams_json|json_script:"live-map-teams" }}
{{ destinations|json_script:"live-map-destinations" }}
{{ team_locations|json_script:"live-map-teamlocs" }}
{{ completed_destinations|json_script:"live-map-completed" }}
<script>
  window.TAPA_MAP_BOOT = {
    apiKey: "{{ GOOGLE_MAPS_API_KEY }}",
    mapId: "{{ GOOGLE_MAPS_MAP_ID }}",
  };
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&v=weekly&loading=async{% if GOOGLE_MAPS_MAP_ID %}&map_ids={{ GOOGLE_MAPS_MAP_ID }}{% endif %}"></script>
<script defer src="{% static 'backoffice/route_map.js' %}"></script>
{% endblock %}
