{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>TapawingoHikeEditor · RouteParts · {{ route.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- libs -->
  <script src="https://unpkg.com/htmx.org@2.0.2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

  <style>
    .panel-enter {
    opacity: 0;
    transform: translateX(16px);
    transition: all .18s ease;
    }
    .panel-enter.show {
    opacity: 1;
    transform: translateX(0);
    }    
    .row-hover:hover{background:#f8fafc}
    .handle{cursor:grab}
    #hx-indicator { display: none; }
    #hx-indicator.htmx-request { display: block; }
    .icon-btn{
        background: transparent;
        border: 0;
        padding: 2px;
        line-height: 1;
        color: #64748b;            /* slate-500 */
        border-radius: 8px;
        cursor: pointer;
    }
    .icon-btn:hover{ color: #0f172a; }          /* slate-900 */
    .icon-btn:focus{ outline: 2px solid rgba(148,163,184,.6); outline-offset: 2px; } /* slate-400 ring */
    .icon-btn.danger:hover{ color:#dc2626; }    /* rood bij hover */    
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-7xl mx-auto p-4 h-screen flex flex-col">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-xl font-semibold">RouteParts · {{ route.name }}</h1>
      <div class="text-sm text-slate-600">Edition: {{ route.edition.name }}</div>
    </div>
    <div class="flex items-center gap-2">
      <a class="px-3 py-1 bg-slate-200 rounded" href="{% url 'backoffice:routes_page' %}">← Terug</a>

    </div>
  </div>

  <div class="grid grid-cols-3 gap-4 flex-1 min-h-0">
    <!-- Kaart -->
    <div class="col-span-2">
      <div id="map"
           class="w-full h-full bg-white rounded shadow-sm"
           data-map-id="{{ GOOGLE_MAPS_MAP_ID }}"
           data-route-id="{{ route.id }}"></div>
    </div>

    <!-- Rechterkolom: 60/40 split + scroll -->
    <div class="col-span-1 h-full min-h-0 grid grid-rows-[11fr_9fr] gap-3">
      <!-- Lijst (Sortable) met scrollbar -->
      <div class="bg-white rounded shadow-sm p-3 overflow-auto min-h-0">
        
        <div class="mb-2 flex items-center justify-between">
            <div class="font-medium">RouteParts</div>

            <!-- icon-only + knop (Heroicons via Iconify) -->
            <button class="icon-btn"
                    title="Nieuw routepart"
                    aria-label="Nieuw routepart"
                    hx-get="{% url 'backoffice:routepart_new' route.id %}"
                    hx-target="#sidepanel" hx-swap="innerHTML">
                <iconify-icon icon="heroicons-outline:plus" width="18" height="18"></iconify-icon>
            </button>
        </div>
        <ul id="parts-list" class="space-y-1">
          {% for p in parts %}
            {% include "backoffice/_routepart_item.html" with p=p route=route %}
          {% empty %}
            <li class="text-slate-500">Nog geen onderdelen</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Zijpaneel voor formulieren (scrollbaar) -->
      <div id="sidepanel" class="bg-white rounded shadow-sm p-0 overflow-auto min-h-0"></div>
    </div>
  </div>

  <!-- HTMX indicator -->
  <div id="hx-indicator" class="mt-2 text-xs text-slate-500">Laden…</div>
</div>

<!-- JSON payload met alle destinations voor de kaart -->
{{ dest_items|json_script:"routeparts-dests" }}

{% csrf_token %}
<script>
(() => {
  // ---------- CSRF ----------
  function getCsrfToken() {
    const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "{{ csrf_token }}";
  }
  document.body.addEventListener("htmx:configRequest", (e) => {
    e.detail.headers["X-CSRFToken"] = getCsrfToken();
  });

  // ---------- Sortable (RouteParts reorder) ----------
  document.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("parts-list");
    if (!el) return;

    new Sortable(el, {
      handle: ".handle",
      animation: 150,
      onEnd: () => {
        const order = Array.from(el.querySelectorAll("li[data-id]"))
          .map((li) => +li.dataset.id);
        fetch("{% url 'backoffice:routeparts_reorder' route.id %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken()
          },
          body: JSON.stringify({ order })
        }).catch(console.error);
      }
    });
  });

  // ---------- HTMX lifecycle ----------
  document.body.addEventListener("htmx:afterSwap", (e) => {
    const tgt = e.target;

    // Sidepanel animatie (panel-enter → show)
    if (tgt && tgt.id === "sidepanel") {
      const root = tgt.firstElementChild;
      if (root && root.classList.contains("panel-enter")) {
        requestAnimationFrame(() => root.classList.add("show"));
      }
    }

    // Recolor legenda als parts-list ververst is
    if (tgt && (tgt.id === "parts-list" || tgt.closest?.("#parts-list"))) {
      window.routepartsMapRefreshLegend && window.routepartsMapRefreshLegend();
    }
  });

  // Na opslaan routepart: paneel sluiten + legenda refresh
  document.body.addEventListener("routepart:saved", () => {
    const sp = document.getElementById("sidepanel");
    if (sp) sp.innerHTML = "";
    window.routepartsMapRefreshLegend && window.routepartsMapRefreshLegend();
  });

  // Init: kleur legenda bij eerste load
  document.addEventListener("DOMContentLoaded", () => {
    window.routepartsMapRefreshLegend && window.routepartsMapRefreshLegend();
  });

  // ---------- Sidepanel leeg → add-mode uit ----------
  (function observeSidepanel() {
    const sp = document.getElementById("sidepanel");
    if (!sp) return;
    const obs = new MutationObserver(() => {
      const empty = sp.childElementCount === 0 || sp.innerHTML.trim() === "";
      if (empty) window.clearActivePart && window.clearActivePart();
    });
    obs.observe(sp, { childList: true });
  })();

  // ESC sluit paneel + verlaat add-mode
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const sp = document.getElementById("sidepanel");
      if (sp) sp.innerHTML = "";
      window.clearActivePart && window.clearActivePart();
    }
  });

  // ---------- Global loading indicator ----------
  (function attachIndicator() {
    const ind = document.getElementById("hx-indicator");
    if (!ind) return;

    const show = () => ind.classList.add("show");
    const hide = () => ind.classList.remove("show");

    document.body.addEventListener("htmx:beforeRequest", show);
    ["htmx:afterSwap", "htmx:afterRequest", "htmx:responseError",
     "htmx:sendError", "htmx:timeout", "htmx:abort"]
      .forEach((ev) => document.body.addEventListener(ev, hide));
  })();
})();
</script>


<!-- Google Maps (loading=async, optioneel map_ids) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&v=weekly&loading=async{% if GOOGLE_MAPS_MAP_ID %}&map_ids={{ GOOGLE_MAPS_MAP_ID }}{% endif %}"></script>
<script defer src="{% static 'backoffice/routeparts_map.js' %}"></script>
</body>
</html>
